import { useMemo, useRef, useState, useCallback, useEffect } from 'react'
import { Canvas, useFrame, useThree } from '@react-three/fiber'
import { Text, Html } from '@react-three/drei'
import PropTypes from 'prop-types'

// Pastel colors for post-it notes
const POSTIT_COLORS = ['#FCCCC7', '#E3AFBD', '#FAF7E4', '#BBE3F0', '#F4D4B2']

// Get severity badge color
function getSeverityColor(severity) {
  switch (severity?.toUpperCase()) {
    case 'CRITICAL': return '#dc2626'
    case 'HIGH': return '#ea580c'
    case 'MODERATE': return '#f59e0b'
    case 'LOW': return '#84cc16'
    default: return '#6b7280'
  }
}

// Get CVE ID from aliases
function getCveId(vuln) {
  const aliases = vuln.aliases || []
  return aliases.find(a => a.startsWith('CVE-')) || vuln.id
}

// Single 3D Post-it note - larger and more readable
function PostItNote3D({ vuln, position, color }) {
  const groupRef = useRef()
  const [hovered, setHovered] = useState(false)
  
  // Animate the whole group on hover - move forward
  useFrame(() => {
    if (groupRef.current) {
      const targetZ = hovered ? 0.3 : 0
      groupRef.current.position.z += (targetZ - groupRef.current.position.z) * 0.15
    }
  })

  const cveId = getCveId(vuln)
  const nvdLink = cveId?.startsWith('CVE-') ? `https://nvd.nist.gov/vuln/detail/${cveId}` : null
  
  // Seeded random for consistent rotation
  const rotation = useMemo(() => {
    const seed = (vuln.id?.charCodeAt(0) || 0) + position[0] * 100
    const r1 = Math.sin(seed * 9999) * 10000
    const r2 = Math.sin(seed * 7777) * 10000
    return [
      (r1 - Math.floor(r1) - 0.5) * 0.08,
      0,
      (r2 - Math.floor(r2) - 0.5) * 0.06
    ]
  }, [vuln.id, position])

  // Text z position - always in front of the mesh
  const textZ = 0.08

  return (
    <group ref={groupRef} position={position} rotation={rotation}>
      {/* Post-it note base - larger */}
      <mesh
        position={[0, 0, 0.02]}
        onPointerOver={() => setHovered(true)}
        onPointerOut={() => setHovered(false)}
      >
        <boxGeometry args={[1.8, 1.4, 0.03]} />
        <meshStandardMaterial color={color} />
      </mesh>
      
      {/* Black border */}
      <mesh position={[0, 0, 0.01]}>
        <boxGeometry args={[1.82, 1.42, 0.02]} />
        <meshBasicMaterial color="#1a1a1a" wireframe />
      </mesh>

      {/* Severity badge - larger */}
      <mesh position={[-0.55, 0.55, textZ - 0.01]}>
        <boxGeometry args={[0.5, 0.18, 0.01]} />
        <meshBasicMaterial color={getSeverityColor(vuln.severity)} />
      </mesh>
      
      <Text
        position={[-0.55, 0.55, textZ]}
        fontSize={0.1}
        color="#ffffff"
        anchorX="center"
        anchorY="middle"
        fontWeight="bold"
      >
        {vuln.severity || 'UNKNOWN'}
      </Text>

      {/* Vulnerability ID */}
      <Text
        position={[0.35, 0.55, textZ]}
        fontSize={0.08}
        color="#374151"
        anchorX="center"
        anchorY="middle"
      >
        {vuln.id?.substring(0, 20) || 'N/A'}
      </Text>

      {/* CVE link */}
      {cveId && (
        <Text
          position={[0, 0.3, textZ]}
          fontSize={0.1}
          color="#2563eb"
          anchorX="center"
          anchorY="middle"
        >
          {cveId}
        </Text>
      )}

      {/* Summary text - larger */}
      <Text
        position={[0, -0.05, textZ]}
        fontSize={0.07}
        color="#1f2937"
        anchorX="center"
        anchorY="middle"
        maxWidth={1.6}
        textAlign="center"
        lineHeight={1.2}
      >
        {(vuln.summary || 'No summary available').substring(0, 120)}
        {(vuln.summary?.length > 120) ? '...' : ''}
      </Text>

      {/* Fixed version info */}
      {vuln.fixed && (
        <Text
          position={[0, -0.45, textZ]}
          fontSize={0.07}
          color="#16a34a"
          anchorX="center"
          anchorY="middle"
        >
          ‚úì Fixed in: {vuln.fixed}
        </Text>
      )}

      {/* Introduced version */}
      {vuln.introduced && (
        <Text
          position={[0, -0.55, textZ]}
          fontSize={0.06}
          color="#6b7280"
          anchorX="center"
          anchorY="middle"
        >
          Introduced: {vuln.introduced}
        </Text>
      )}

      {/* Hover tooltip with links */}
      {hovered && (
        <Html position={[0, 0.9, 0.15]} center>
          <div className="bg-white p-4 rounded-lg shadow-2xl min-w-[300px] max-w-[400px] border border-gray-200">
            <div className="flex items-center gap-2 mb-2">
              <span 
                className="px-2 py-1 rounded text-sm font-bold text-white"
                style={{ backgroundColor: getSeverityColor(vuln.severity) }}
              >
                {vuln.severity || 'UNKNOWN'}
              </span>
              <span className="text-sm text-gray-600">{vuln.id}</span>
            </div>
            
            {nvdLink && (
              <a 
                href={nvdLink}
                target="_blank"
                rel="noopener noreferrer"
                className="text-sm text-blue-600 hover:underline block mb-2 font-medium"
              >
                üìã {cveId} - View on NVD
              </a>
            )}
            
            <p className="text-sm text-gray-700 mb-3">{vuln.summary}</p>
            
            {vuln.details && (
              <p className="text-xs text-gray-500 mb-2 line-clamp-3">{vuln.details}</p>
            )}
            
            {vuln.references?.length > 0 && (
              <div className="border-t pt-2 mt-2">
                <p className="text-xs text-gray-500 mb-1">References:</p>
                {vuln.references?.slice(0, 4).map((ref, i) => (
                  <a 
                    key={i}
                    href={ref.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-xs text-blue-500 hover:underline block truncate"
                  >
                    üîó {ref.url}
                  </a>
                ))}
              </div>
            )}
          </div>
        </Html>
      )}
    </group>
  )
}

PostItNote3D.propTypes = {
  vuln: PropTypes.object.isRequired,
  position: PropTypes.array.isRequired,
  color: PropTypes.string.isRequired,
}

// Wall background for post-its
function WallBackground({ width, height }) {
  return (
    <mesh position={[0, 0, -0.1]}>
      <planeGeometry args={[width + 1, height + 1]} />
      <meshStandardMaterial color="#f3f4f6" />
    </mesh>
  )
}

WallBackground.propTypes = {
  width: PropTypes.number.isRequired,
  height: PropTypes.number.isRequired,
}

// Camera controller for vertical scrolling
function CameraController({ scrollOffset, maxScroll }) {
  const { camera } = useThree()
  
  useFrame(() => {
    // Move camera vertically based on scroll
    const targetY = 1 - scrollOffset
    camera.position.y += (targetY - camera.position.y) * 0.1
    camera.lookAt(0, camera.position.y, 0)
  })

  return null
}

CameraController.propTypes = {
  scrollOffset: PropTypes.number.isRequired,
  maxScroll: PropTypes.number.isRequired,
}

// Main 3D scene with post-it notes
function PostItWallScene({ vulns, scrollOffset }) {
  // Arrange post-its in a grid - 3 columns for better readability
  const { positions, wallHeight, wallWidth } = useMemo(() => {
    const posArr = []
    const cols = 3
    const spacingX = 2.0
    const spacingY = 1.6
    const startX = -((cols - 1) * spacingX) / 2
    const startY = 1.5
    
    vulns.forEach((_, i) => {
      const col = i % cols
      const row = Math.floor(i / cols)
      posArr.push([
        startX + col * spacingX,
        startY - row * spacingY,
        0
      ])
    })
    
    const rows = Math.ceil(vulns.length / cols)
    return {
      positions: posArr,
      wallHeight: Math.max(4, rows * spacingY + 2),
      wallWidth: cols * spacingX + 2
    }
  }, [vulns])

  return (
    <>
      {/* Lighting */}
      <ambientLight intensity={0.9} />
      <directionalLight position={[0, 2, 5]} intensity={0.4} />

      {/* Wall background */}
      <WallBackground width={wallWidth} height={wallHeight} />

      {/* Camera controller for scrolling */}
      <CameraController scrollOffset={scrollOffset} maxScroll={wallHeight} />

      {/* Post-it notes */}
      {vulns.map((vuln, index) => (
        <PostItNote3D
          key={vuln.id + index}
          vuln={vuln}
          position={positions[index]}
          color={POSTIT_COLORS[index % POSTIT_COLORS.length]}
        />
      ))}

      {/* No vulnerabilities message */}
      {vulns.length === 0 && (
        <group position={[0, 1, 0]}>
          <Text
            position={[0, 0.3, 0.1]}
            fontSize={0.4}
            color="#16a34a"
            anchorX="center"
            anchorY="middle"
          >
            üéâ No Vulnerabilities!
          </Text>
          <Text
            position={[0, -0.2, 0.1]}
            fontSize={0.15}
            color="#6b7280"
            anchorX="center"
            anchorY="middle"
          >
            This version appears to be clean.
          </Text>
        </group>
      )}
    </>
  )
}

PostItWallScene.propTypes = {
  vulns: PropTypes.array.isRequired,
  scrollOffset: PropTypes.number.isRequired,
}

// Main exported component
function VulnerabilityView({ auditData, version, onBack }) {
  const [scrollOffset, setScrollOffset] = useState(0)
  const containerRef = useRef()

  // Get vulnerabilities for this version
  const vulns = useMemo(() => {
    if (!auditData?.vulnerabilities) return []
    return auditData.vulnerabilities.filter(vuln => {
      if (vuln.affected_versions?.includes(version)) return true
      if (vuln.introduced && vuln.fixed) {
        return version >= vuln.introduced && version < vuln.fixed
      }
      if (vuln.introduced && !vuln.fixed) {
        return version >= vuln.introduced
      }
      return true
    })
  }, [auditData, version])

  // Calculate max scroll based on number of vulnerabilities
  const maxScroll = useMemo(() => {
    const rows = Math.ceil(vulns.length / 3)
    return Math.max(0, (rows - 2) * 1.6)
  }, [vulns])

  // Handle scroll/wheel events
  const handleWheel = useCallback((e) => {
    e.preventDefault()
    setScrollOffset(prev => {
      const delta = e.deltaY * 0.005
      return Math.max(0, Math.min(maxScroll, prev + delta))
    })
  }, [maxScroll])

  // Handle slider change
  const handleSliderChange = useCallback((e) => {
    setScrollOffset(parseFloat(e.target.value))
  }, [])

  // Reset scroll when version changes
  useEffect(() => {
    setScrollOffset(0)
  }, [version])

  return (
    <div 
      ref={containerRef}
      className="relative w-full h-screen"
      style={{ backgroundColor: '#FAFBFD' }}
      onWheel={handleWheel}
    >
      {/* Header overlay with SNYK link */}
      <div className="absolute top-4 left-4 z-20">
        <div className="bg-white/95 backdrop-blur-sm rounded-lg px-5 py-4 shadow-lg">
          <a 
            href={`https://security.snyk.io/package/${auditData.package.ecosystem?.toLowerCase() || 'pip'}/${auditData.package.name}/${version}`}
            target="_blank"
            rel="noopener noreferrer"
            className="group"
          >
            <h2 className="text-2xl font-bold text-gray-800 group-hover:text-blue-600 transition-colors flex items-center gap-2">
              üì¶ {auditData.package.name}
              <span className="text-sm text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity">‚Üó View on Snyk</span>
            </h2>
          </a>
          <p className="text-gray-600">
            Version <span className="font-mono font-medium">{version}</span> ‚Ä¢ {vulns.length} vulnerabilit{vulns.length === 1 ? 'y' : 'ies'}
          </p>
        </div>
      </div>

      {/* Back button */}
      <div className="absolute top-4 right-4 z-20">
        <button
          onClick={onBack}
          className="bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 
                     text-white font-medium px-5 py-3 rounded-lg shadow-lg
                     flex items-center gap-2 transition-all duration-200 hover:shadow-xl"
        >
          <span>‚Üê</span>
          <span>Back to Houses</span>
        </button>
      </div>

      {/* 3D Canvas - Close-up of wall */}
      <Canvas
        camera={{ position: [0, 1, 5], fov: 50 }}
        className="cursor-default"
      >
        <PostItWallScene vulns={vulns} scrollOffset={scrollOffset} />
      </Canvas>

      {/* Scroll controls - only show if there are many vulns */}
      {vulns.length > 6 && (
        <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 w-1/2 max-w-md">
          <div className="bg-white/95 backdrop-blur-sm rounded-lg px-4 py-3 shadow-lg">
            <div className="flex items-center gap-4">
              <span className="text-gray-600 text-sm font-medium whitespace-nowrap">
                {vulns.length} vulns
              </span>
              <input
                type="range"
                min="0"
                max={maxScroll || 1}
                step="0.05"
                value={scrollOffset}
                onChange={handleSliderChange}
                className="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-orange-500"
              />
              <span className="text-gray-500 text-xs whitespace-nowrap">
                Scroll to view more
              </span>
            </div>
          </div>
        </div>
      )}

      {/* Instructions */}
      <div className="absolute bottom-4 right-4">
        <div className="bg-white/90 backdrop-blur-sm rounded-lg px-3 py-2 shadow-lg">
          <p className="text-gray-500 text-xs">
            Hover notes for details & links
          </p>
        </div>
      </div>
    </div>
  )
}

VulnerabilityView.propTypes = {
  auditData: PropTypes.object.isRequired,
  version: PropTypes.string.isRequired,
  onBack: PropTypes.func.isRequired,
}

export default VulnerabilityView
