import { useMemo, useRef, useState } from 'react'
import { Canvas, useFrame } from '@react-three/fiber'
import { Text, Html } from '@react-three/drei'
import PropTypes from 'prop-types'
import * as THREE from 'three'

// Pastel colors for post-it notes
const POSTIT_COLORS = ['#FCCCC7', '#E3AFBD', '#FAF7E4', '#BBE3F0', '#F4D4B2']

// Get severity badge color
function getSeverityColor(severity) {
  switch (severity?.toUpperCase()) {
    case 'CRITICAL': return '#dc2626'
    case 'HIGH': return '#ea580c'
    case 'MODERATE': return '#f59e0b'
    case 'LOW': return '#84cc16'
    default: return '#6b7280'
  }
}

// Get CVE ID from aliases
function getCveId(vuln) {
  const aliases = vuln.aliases || []
  return aliases.find(a => a.startsWith('CVE-')) || vuln.id
}

// Single 3D Post-it note on the wall
function PostItNote3D({ vuln, position, color, index }) {
  const meshRef = useRef()
  const [hovered, setHovered] = useState(false)
  
  // Slight animation on hover
  useFrame(() => {
    if (meshRef.current) {
      const targetZ = hovered ? 0.15 : 0.05
      meshRef.current.position.z += (targetZ - meshRef.current.position.z) * 0.1
    }
  })

  const cveId = getCveId(vuln)
  const nvdLink = cveId?.startsWith('CVE-') ? `https://nvd.nist.gov/vuln/detail/${cveId}` : null
  
  // Random slight rotation for natural look
  const rotation = useMemo(() => [
    (Math.random() - 0.5) * 0.1,
    0,
    (Math.random() - 0.5) * 0.08
  ], [])

  return (
    <group position={position} rotation={rotation}>
      {/* Post-it note base */}
      <mesh
        ref={meshRef}
        position={[0, 0, 0.05]}
        onPointerOver={() => setHovered(true)}
        onPointerOut={() => setHovered(false)}
      >
        <boxGeometry args={[0.9, 0.9, 0.02]} />
        <meshStandardMaterial color={color} />
      </mesh>
      
      {/* Black border */}
      <mesh position={[0, 0, 0.04]}>
        <boxGeometry args={[0.92, 0.92, 0.01]} />
        <meshBasicMaterial color="#1a1a1a" wireframe />
      </mesh>

      {/* Severity badge */}
      <mesh position={[-0.3, 0.35, 0.07]}>
        <boxGeometry args={[0.25, 0.1, 0.01]} />
        <meshBasicMaterial color={getSeverityColor(vuln.severity)} />
      </mesh>
      
      <Text
        position={[-0.3, 0.35, 0.08]}
        fontSize={0.05}
        color="#ffffff"
        anchorX="center"
        anchorY="middle"
        fontWeight="bold"
      >
        {vuln.severity || 'UNKNOWN'}
      </Text>

      {/* Vulnerability ID */}
      <Text
        position={[0.15, 0.35, 0.07]}
        fontSize={0.04}
        color="#374151"
        anchorX="center"
        anchorY="middle"
      >
        {vuln.id?.substring(0, 18) || 'N/A'}
      </Text>

      {/* CVE link */}
      {cveId && (
        <Text
          position={[0, 0.2, 0.07]}
          fontSize={0.045}
          color="#2563eb"
          anchorX="center"
          anchorY="middle"
        >
          {cveId}
        </Text>
      )}

      {/* Summary text */}
      <Text
        position={[0, 0, 0.07]}
        fontSize={0.035}
        color="#1f2937"
        anchorX="center"
        anchorY="middle"
        maxWidth={0.8}
        textAlign="center"
        lineHeight={1.3}
      >
        {(vuln.summary || 'No summary').substring(0, 80)}
        {(vuln.summary?.length > 80) ? '...' : ''}
      </Text>

      {/* Fixed version info */}
      {vuln.fixed && (
        <Text
          position={[0, -0.25, 0.07]}
          fontSize={0.035}
          color="#16a34a"
          anchorX="center"
          anchorY="middle"
        >
          Fixed in: {vuln.fixed}
        </Text>
      )}

      {/* Introduced version */}
      {vuln.introduced && (
        <Text
          position={[0, -0.32, 0.07]}
          fontSize={0.03}
          color="#6b7280"
          anchorX="center"
          anchorY="middle"
        >
          Introduced: {vuln.introduced}
        </Text>
      )}

      {/* Hover tooltip with links */}
      {hovered && (
        <Html position={[0, 0.6, 0.1]} center>
          <div className="bg-white p-3 rounded-lg shadow-xl min-w-[250px] max-w-[350px] border border-gray-200">
            <div className="flex items-center gap-2 mb-2">
              <span 
                className="px-2 py-0.5 rounded text-xs font-bold text-white"
                style={{ backgroundColor: getSeverityColor(vuln.severity) }}
              >
                {vuln.severity || 'UNKNOWN'}
              </span>
              <span className="text-xs text-gray-500">{vuln.id}</span>
            </div>
            
            {nvdLink && (
              <a 
                href={nvdLink}
                target="_blank"
                rel="noopener noreferrer"
                className="text-sm text-blue-600 hover:underline block mb-2"
              >
                üìã {cveId} (NVD)
              </a>
            )}
            
            <p className="text-xs text-gray-700 mb-2 line-clamp-3">{vuln.summary}</p>
            
            {vuln.references?.slice(0, 3).map((ref, i) => (
              <a 
                key={i}
                href={ref.url}
                target="_blank"
                rel="noopener noreferrer"
                className="text-xs text-blue-500 hover:underline block truncate"
              >
                üîó {ref.url?.substring(0, 40)}...
              </a>
            ))}
          </div>
        </Html>
      )}
    </group>
  )
}

PostItNote3D.propTypes = {
  vuln: PropTypes.object.isRequired,
  position: PropTypes.array.isRequired,
  color: PropTypes.string.isRequired,
  index: PropTypes.number.isRequired,
}

// House interior walls
function HouseInterior() {
  return (
    <group>
      {/* Back wall (where post-its go) */}
      <mesh position={[0, 2, -3]}>
        <boxGeometry args={[8, 5, 0.2]} />
        <meshStandardMaterial color="#f3f4f6" />
      </mesh>
      
      {/* Left wall (cutoff/partial) */}
      <mesh position={[-3.5, 2, 0]} rotation={[0, Math.PI / 2, 0]}>
        <boxGeometry args={[6, 5, 0.2]} />
        <meshStandardMaterial color="#e5e7eb" transparent opacity={0.6} />
      </mesh>
      
      {/* Right wall (cutoff/partial) */}
      <mesh position={[3.5, 2, 0]} rotation={[0, Math.PI / 2, 0]}>
        <boxGeometry args={[6, 5, 0.2]} />
        <meshStandardMaterial color="#e5e7eb" transparent opacity={0.6} />
      </mesh>
      
      {/* Floor */}
      <mesh position={[0, 0, 0]} rotation={[-Math.PI / 2, 0, 0]}>
        <planeGeometry args={[8, 6]} />
        <meshStandardMaterial color="#d1d5db" />
      </mesh>
      
      {/* Ceiling hint */}
      <mesh position={[0, 4.5, 0]} rotation={[Math.PI / 2, 0, 0]}>
        <planeGeometry args={[8, 6]} />
        <meshStandardMaterial color="#f9fafb" transparent opacity={0.5} />
      </mesh>
    </group>
  )
}

// Main 3D scene inside the house
function InsideHouseScene({ vulns }) {
  // Arrange post-its on the wall in a grid
  const postItPositions = useMemo(() => {
    const positions = []
    const cols = 4
    const rows = Math.ceil(vulns.length / cols)
    const spacingX = 1.1
    const spacingY = 1.1
    const startX = -((Math.min(vulns.length, cols) - 1) * spacingX) / 2
    const startY = 2.5
    
    vulns.forEach((_, i) => {
      const col = i % cols
      const row = Math.floor(i / cols)
      positions.push([
        startX + col * spacingX,
        startY - row * spacingY,
        -2.8
      ])
    })
    
    return positions
  }, [vulns])

  return (
    <>
      {/* Lighting */}
      <ambientLight intensity={0.8} />
      <directionalLight position={[0, 5, 5]} intensity={0.5} />
      <pointLight position={[0, 3, 0]} intensity={0.3} color="#fff5e6" />

      {/* House interior */}
      <HouseInterior />

      {/* Post-it notes on the wall */}
      {vulns.slice(0, 12).map((vuln, index) => (
        <PostItNote3D
          key={vuln.id + index}
          vuln={vuln}
          position={postItPositions[index]}
          color={POSTIT_COLORS[index % POSTIT_COLORS.length]}
          index={index}
        />
      ))}

      {/* Message if more vulns */}
      {vulns.length > 12 && (
        <Text
          position={[0, 0.3, -2.5]}
          fontSize={0.15}
          color="#6b7280"
          anchorX="center"
          anchorY="middle"
        >
          +{vulns.length - 12} more vulnerabilities...
        </Text>
      )}

      {/* No vulnerabilities message */}
      {vulns.length === 0 && (
        <group position={[0, 2, -2.5]}>
          <Text
            position={[0, 0.3, 0]}
            fontSize={0.3}
            color="#16a34a"
            anchorX="center"
            anchorY="middle"
          >
            üéâ No Vulnerabilities!
          </Text>
          <Text
            position={[0, -0.1, 0]}
            fontSize={0.12}
            color="#6b7280"
            anchorX="center"
            anchorY="middle"
          >
            This version appears to be clean.
          </Text>
        </group>
      )}
    </>
  )
}

InsideHouseScene.propTypes = {
  vulns: PropTypes.array.isRequired,
}

// Main exported component
function VulnerabilityView({ auditData, version, onBack }) {
  // Get vulnerabilities for this version
  const vulns = useMemo(() => {
    if (!auditData?.vulnerabilities) return []
    return auditData.vulnerabilities.filter(vuln => {
      if (vuln.affected_versions?.includes(version)) return true
      if (vuln.introduced && vuln.fixed) {
        return version >= vuln.introduced && version < vuln.fixed
      }
      if (vuln.introduced && !vuln.fixed) {
        return version >= vuln.introduced
      }
      return true
    })
  }, [auditData, version])

  return (
    <div 
      className="relative w-full h-[600px]"
      style={{ backgroundColor: '#FAFBFD' }}
    >
      {/* Header overlay */}
      <div className="absolute top-4 left-4 z-20">
        <div className="bg-white/95 backdrop-blur-sm rounded-lg px-4 py-3 shadow-lg">
          <h2 className="text-xl font-bold text-gray-800">
            üì¶ {auditData.package.name}
          </h2>
          <p className="text-gray-600 text-sm">
            Version {version} ‚Ä¢ {vulns.length} vulnerabilit{vulns.length === 1 ? 'y' : 'ies'}
          </p>
        </div>
      </div>

      {/* Back button */}
      <div className="absolute top-4 right-4 z-20">
        <button
          onClick={onBack}
          className="bg-white hover:bg-gray-50 text-gray-700 font-medium px-4 py-2 rounded-lg shadow-lg
                     flex items-center gap-2 transition-all duration-200 hover:shadow-xl"
        >
          <span>‚Üê</span>
          <span>Back to Houses</span>
        </button>
      </div>

      {/* 3D Canvas - Inside the house */}
      <Canvas
        camera={{ position: [0, 2, 4], fov: 60 }}
        className="cursor-default"
      >
        <InsideHouseScene vulns={vulns} />
      </Canvas>

      {/* Instructions */}
      <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2">
        <div className="bg-white/90 backdrop-blur-sm rounded-lg px-4 py-2 shadow-lg">
          <p className="text-gray-600 text-sm">
            Hover over post-it notes for details and links
          </p>
        </div>
      </div>
    </div>
  )
}

VulnerabilityView.propTypes = {
  auditData: PropTypes.object.isRequired,
  version: PropTypes.string.isRequired,
  onBack: PropTypes.func.isRequired,
}

export default VulnerabilityView
