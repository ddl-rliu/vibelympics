import { useMemo } from 'react'
import PropTypes from 'prop-types'

// Pastel colors for post-it notes
const POSTIT_COLORS = ['#FCCCC7', '#E3AFBD', '#FAF7E4', '#BBE3F0', '#F4D4B2']

// Get severity badge color
function getSeverityColor(severity) {
  switch (severity?.toUpperCase()) {
    case 'CRITICAL': return 'bg-red-600'
    case 'HIGH': return 'bg-orange-600'
    case 'MODERATE': return 'bg-yellow-600'
    case 'LOW': return 'bg-green-600'
    default: return 'bg-gray-600'
  }
}

// Single post-it note component
function PostItNote({ vuln, color, index }) {
  // Get CVE ID if available
  const cveId = useMemo(() => {
    const aliases = vuln.aliases || []
    return aliases.find(a => a.startsWith('CVE-')) || vuln.id
  }, [vuln])

  // Get NVD link for CVE
  const nvdLink = useMemo(() => {
    if (cveId?.startsWith('CVE-')) {
      return `https://nvd.nist.gov/vuln/detail/${cveId}`
    }
    return null
  }, [cveId])

  // Filter and format references
  const references = useMemo(() => {
    if (!vuln.references) return []
    return vuln.references.slice(0, 5).map(ref => ({
      url: ref.url,
      type: ref.type || 'REFERENCE',
    }))
  }, [vuln.references])

  // Get credits
  const credits = useMemo(() => {
    if (!vuln.credits) return []
    return vuln.credits.map(c => ({
      name: c.name,
      contact: c.contact?.[0],
    }))
  }, [vuln.credits])

  return (
    <div 
      className="postit p-4 rounded-sm shadow-lg min-w-[280px] max-w-[350px]"
      style={{ 
        backgroundColor: color,
        border: '2px solid #1a1a1a',
      }}
    >
      {/* Header with severity and ID */}
      <div className="flex items-start justify-between gap-2 mb-3">
        <span className={`${getSeverityColor(vuln.severity)} text-white text-xs font-bold px-2 py-1 rounded`}>
          {vuln.severity || 'UNKNOWN'}
          {vuln.score && ` (${vuln.score})`}
        </span>
        <span className="text-xs font-mono text-gray-700 font-bold">
          {vuln.id}
        </span>
      </div>

      {/* CVE Link */}
      {nvdLink && (
        <a 
          href={nvdLink}
          target="_blank"
          rel="noopener noreferrer"
          className="text-sm font-mono text-blue-700 hover:text-blue-900 hover:underline block mb-2"
        >
          üìã {cveId}
        </a>
      )}

      {/* Summary */}
      <h3 className="font-bold text-gray-900 text-sm mb-2 leading-tight">
        {vuln.summary || 'No summary available'}
      </h3>

      {/* Details (truncated) */}
      {vuln.details && (
        <p className="text-xs text-gray-700 mb-3 line-clamp-4">
          {vuln.details}
        </p>
      )}

      {/* Version info */}
      <div className="space-y-1 mb-3">
        {vuln.introduced && (
          <p className="text-xs text-gray-600">
            <span className="font-bold">Introduced:</span> {vuln.introduced}
          </p>
        )}
        {vuln.fixed && (
          <p className="text-xs text-gray-600">
            <span className="font-bold text-green-700">Fixed in:</span> {vuln.fixed}
          </p>
        )}
      </div>

      {/* References */}
      {references.length > 0 && (
        <div className="border-t border-gray-400/50 pt-2 mt-2">
          <p className="text-xs font-bold text-gray-600 mb-1">References:</p>
          <ul className="space-y-1">
            {references.map((ref, i) => (
              <li key={i} className="text-xs">
                <a 
                  href={ref.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-blue-700 hover:text-blue-900 hover:underline break-all line-clamp-1"
                >
                  üîó {ref.url.length > 40 ? ref.url.substring(0, 40) + '...' : ref.url}
                </a>
              </li>
            ))}
          </ul>
        </div>
      )}

      {/* Credits */}
      {credits.length > 0 && (
        <div className="border-t border-gray-400/50 pt-2 mt-2">
          <p className="text-xs font-bold text-gray-600 mb-1">Credits:</p>
          {credits.map((credit, i) => (
            <p key={i} className="text-xs text-gray-600">
              {credit.name}
              {credit.contact && (
                <a 
                  href={credit.contact}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-blue-700 hover:underline ml-1"
                >
                  ‚Üó
                </a>
              )}
            </p>
          ))}
        </div>
      )}
    </div>
  )
}

PostItNote.propTypes = {
  vuln: PropTypes.object.isRequired,
  color: PropTypes.string.isRequired,
  index: PropTypes.number.isRequired,
}

// Wall view with post-it notes
function VulnerabilityView({ auditData, version, onBack }) {
  // Get vulnerabilities for this version
  const vulns = useMemo(() => {
    if (!auditData?.vulnerabilities) return []
    return auditData.vulnerabilities.filter(vuln => {
      if (vuln.affected_versions?.includes(version)) return true
      if (vuln.introduced && vuln.fixed) {
        return version >= vuln.introduced && version < vuln.fixed
      }
      if (vuln.introduced && !vuln.fixed) {
        return version >= vuln.introduced
      }
      return true
    })
  }, [auditData, version])

  return (
    <div 
      className="min-h-[500px] relative"
      style={{
        background: 'linear-gradient(180deg, #4a5568 0%, #2d3748 50%, #1a202c 100%)',
      }}
    >
      {/* Wall texture overlay */}
      <div 
        className="absolute inset-0 opacity-20"
        style={{
          backgroundImage: `repeating-linear-gradient(
            0deg,
            transparent,
            transparent 20px,
            rgba(0,0,0,0.1) 20px,
            rgba(0,0,0,0.1) 21px
          ),
          repeating-linear-gradient(
            90deg,
            transparent,
            transparent 20px,
            rgba(0,0,0,0.1) 20px,
            rgba(0,0,0,0.1) 21px
          )`,
        }}
      />

      {/* Header */}
      <div className="relative z-10 py-6 px-4">
        <div className="max-w-6xl mx-auto flex items-center justify-between">
          <div>
            <h2 className="text-2xl font-display text-white">
              üì¶ {auditData.package.name}
            </h2>
            <p className="text-white/70 font-body text-sm">
              Version {version} ‚Ä¢ {vulns.length} vulnerabilit{vulns.length === 1 ? 'y' : 'ies'}
            </p>
          </div>
          
          <button
            onClick={onBack}
            className="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-500 hover:to-gray-600
                       text-white font-display px-6 py-3 rounded-lg shadow-lg
                       transform transition-all duration-200 hover:scale-105
                       flex items-center gap-2"
          >
            <span>‚Üê</span>
            <span>Back to Houses</span>
          </button>
        </div>
      </div>

      {/* Post-it notes wall */}
      <div className="relative z-10 px-4 pb-8">
        <div className="max-w-6xl mx-auto">
          {vulns.length === 0 ? (
            <div className="flex flex-col items-center justify-center py-16">
              <div className="text-8xl mb-4">üéâ</div>
              <h3 className="text-2xl font-display text-white mb-2">
                No Vulnerabilities!
              </h3>
              <p className="text-white/70 font-body">
                This version appears to be clean. Great choice!
              </p>
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
              {vulns.map((vuln, index) => (
                <PostItNote
                  key={vuln.id}
                  vuln={vuln}
                  color={POSTIT_COLORS[index % POSTIT_COLORS.length]}
                  index={index}
                />
              ))}
            </div>
          )}
        </div>
      </div>

      {/* Floor shadow */}
      <div 
        className="absolute bottom-0 left-0 right-0 h-32"
        style={{
          background: 'linear-gradient(0deg, rgba(0,0,0,0.5) 0%, transparent 100%)',
        }}
      />
    </div>
  )
}

VulnerabilityView.propTypes = {
  auditData: PropTypes.object.isRequired,
  version: PropTypes.string.isRequired,
  onBack: PropTypes.func.isRequired,
}

export default VulnerabilityView

